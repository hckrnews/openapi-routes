{"version":3,"file":"api.umd.js","sources":["../src/api.js"],"sourcesContent":["/**\n * Auto register API routes from the OpenAPI specification.\n */\nclass ApiRoutes {\n  /**\n   * Set the specification.\n   *\n   * @param {object} OpenAPISpecification\n   * @param {class} Backend\n   * @param {function} callback\n   * @param {string} root\n   */\n  constructor (OpenAPISpecification, Backend, callback, root) {\n    this.logger = null\n    this.specification = OpenAPISpecification\n    this.callback = callback\n    this.controllers = {}\n    this.api = new Backend({\n      // Use the first server url as api root.\n      // @todo CDB2BGAZ-3755: Support multiple servers\n      apiRoot: root || OpenAPISpecification.servers[0].url,\n      definition: OpenAPISpecification\n    })\n  }\n\n  get operations () {\n    return ['get', 'put', 'patch', 'post', 'delete']\n  }\n\n  /**\n     * Set the logger.\n     *\n     * @param {class} logger\n     */\n  setLogger (logger) {\n    this.logger = logger\n  }\n\n  /**\n     * Set the controllers.\n     *\n     * @param {object} controllers\n     */\n  setControllers (controllers) {\n    if (controllers === null || controllers.constructor.name !== 'Object') {\n      throw new Error('No valid controllers found')\n    }\n\n    this.controllers = controllers\n  }\n\n  /**\n     * Get all operation ID's from the specification.\n     *\n     * @return {array}\n     */\n  get operationIds () {\n    return Object.values(this.specification.paths).map((path) => {\n      const route = Object.entries(path).find(([operation, data]) =>\n        this.operations.includes(operation) ? data.operationId : null\n      )\n      return route[1]?.operationId\n    })\n  }\n\n  /**\n     * Register all operations to a controller.\n     */\n  register () {\n    this.operationIds.forEach((operationId) => {\n      this.api.register(\n        operationId,\n        this.callback(\n          this.controllers[operationId],\n          this.specification,\n          this.logger\n        )\n      )\n    })\n\n    if (this.controllers?.notFound) {\n      this.api.register(\n        'notFound',\n        this.callback(\n          this.controllers.notFound,\n          this.specification,\n          this.logger\n        )\n      )\n    }\n\n    this.api.init()\n  }\n\n  authentication (secret) {\n    this.api.register(\n      'unauthorizedHandler',\n      async (context, request, response) =>\n        response.status(401).json({\n          status: 401,\n          timestamp: new Date(),\n          message: 'Unauthorized'\n        })\n    )\n    this.api.registerSecurityHandler(\n      'apiKey',\n      (context) => context.request.headers['x-api-key'] === secret\n    )\n  }\n\n  /**\n     * Create the API routes from a specification.\n     *\n     * @param {object} specification\n     * @param {string} secret\n     * @param {class} Backend\n     * @param {class} logger\n     * @param {function} callback\n     * @param {object} controllers\n     * @param {string} root\n     *\n     * @return {OpenAPIBackend}\n     */\n  static create ({\n    specification,\n    secret,\n    Backend,\n    logger,\n    callback,\n    controllers,\n    root\n  }) {\n    const apiRoutes = new ApiRoutes(specification, Backend, callback, root)\n\n    apiRoutes.setControllers(controllers)\n    if (logger) {\n      apiRoutes.setLogger(logger)\n    }\n\n    if (secret) {\n      apiRoutes.authentication(secret)\n    }\n\n    apiRoutes.register()\n\n    return apiRoutes.api\n  }\n}\n\nexport { ApiRoutes }\n"],"names":["ApiRoutes","constructor","OpenAPISpecification","Backend","callback","root","logger","specification","controllers","api","apiRoot","servers","url","definition","operations","setLogger","setControllers","name","Error","operationIds","Object","values","paths","map","path","route","entries","find","operation","data","includes","operationId","register","forEach","notFound","init","authentication","secret","context","request","response","status","json","timestamp","Date","message","registerSecurityHandler","headers","create","apiRoutes"],"mappings":"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"}